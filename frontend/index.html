<!doctype html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>å¤©æ°”æ™ºèƒ½ç½‘ç«™</title>
	<link rel="stylesheet" href="/static/style.css" />
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
	<div class="container">
		<div class="topbar" style="justify-content:flex-end">
			<input id="city-search" list="city-suggestions" placeholder="æœç´¢åŸå¸‚(ä¸­æ–‡/æ‹¼éŸ³/English)" style="padding:8px 12px;border:1px solid var(--card-border);background:var(--card-bg);color:var(--fg);border-radius:10px;min-width:220px" />
			<datalist id="city-suggestions"></datalist>
			<select id="city">
				<option value="åŒ—äº¬" selected>åŒ—äº¬</option>
				<option value="ä¸Šæµ·">ä¸Šæµ·</option>
				<option value="å¹¿å·">å¹¿å·</option>
				<option value="æ·±åœ³">æ·±åœ³</option>
			</select>
			<span id="city-label" class="chip">åŒ—äº¬</span>
			<button id="btn-ip-city" class="btn-primary" style="padding:8px 12px">IP</button>
			<select id="lang">
				<option value="zh">ä¸­æ–‡</option>
				<option value="en">English</option>
			</select>
			<select id="theme">
				<option value="system" data-i18n="theme.system">ç³»ç»Ÿ</option>
				<option value="light" data-i18n="theme.light">æµ…è‰²</option>
				<option value="dark" data-i18n="theme.dark">æ·±è‰²</option>
			</select>
		</div>

		<div class="assistant">
			<h1 id="title-assistant" data-i18n="assistant.title">ç”Ÿæ´»åŠ©æ‰‹</h1>
			<div class="input-row">
				<input id="query" type="text" data-i18n-placeholder="assistant.placeholder" placeholder="å‘Šè¯‰æˆ‘ï¼šæ˜å¤©/åå¤©ç©¿ä»€ä¹ˆï¼Ÿ è¦ä¸è¦å¸¦ä¼ï¼Ÿ" />
				<button id="btn-send" class="btn-primary" data-i18n="assistant.send">å‘é€</button>
			</div>
			<div id="result" class="advice" style="margin-top:10px"></div>
		</div>

		<h2 id="title-extremes" data-i18n="extremes.title">æœªæ¥æç«¯å¤©æ°”</h2>
		<div id="extremes" class="extremes"></div>

		<h2 id="title-forecast" data-i18n="forecast.title">æœªæ¥7å¤©é¢„æŠ¥</h2>
		<div id="cards" class="cards"></div>

		<div class="section">
			<h2 id="title-history" data-i18n="history.title">è¿‘14å¤©ï¼ˆæ°”æ¸©&é™æ°´ï¼‰</h2>
			<canvas id="histChart" height="120"></canvas>
			<div class="hint" id="hint-refresh" data-i18n="history.hint">æ•°æ®ä¸å¯¹ï¼Ÿ<a href="#" onclick="refreshData();return false;">åˆ·æ–°æ•°æ®</a></div>
		</div>
	</div>

	<!-- ä¿®æ”¹lifeAssistantå®Œæ•´åŠŸèƒ½æ¨¡å— -->
	<div class="container">
		<div class="life-assistant-card">
			<div class="life-assistant-header">
				<h1>ğŸŒ¤ï¸ æ™ºèƒ½å¤©æ°”å»ºè®®ç³»ç»Ÿ</h1>
				<p>åŸºäºAIçš„ä¸ªæ€§åŒ–å¤©æ°”å»ºè®®ï¼Œè®©ä½ çš„æ¯ä¸€å¤©éƒ½æ›´ç¾å¥½</p>
			</div>

			<div class="life-assistant-content">
				<div class="life-assistant-left">
					<h3>ğŸ“Š å¤©æ°”ä¿¡æ¯è¾“å…¥</h3>
					<form id="lifeWeatherForm" class="weather-input-form">
						<div class="form-group">
							<label for="lifeTemperature">æ¸©åº¦ (Â°C)</label>
							<input type="number" id="lifeTemperature" name="temperature" value="25" min="-50" max="50" class="form-input">
						</div>
						 
						<div class="form-group">
							<label for="lifeWeather">å¤©æ°”çŠ¶å†µ</label>
							<select id="lifeWeather" name="weather" class="form-select">
								<option value="æ™´å¤©">æ™´å¤©</option>
								<option value="å¤šäº‘">å¤šäº‘</option>
								<option value="é˜´å¤©">é˜´å¤©</option>
								<option value="å°é›¨">å°é›¨</option>
								<option value="ä¸­é›¨">ä¸­é›¨</option>
								<option value="å¤§é›¨">å¤§é›¨</option>
								<option value="å°é›ª">å°é›ª</option>
								<option value="ä¸­é›ª">ä¸­é›ª</option>
								<option value="å¤§é›ª">å¤§é›ª</option>
								<option value="é›¾">é›¾</option>
								<option value="éœ¾">éœ¾</option>
							</select>
						</div>
						 
						<div class="form-group">
							<label for="lifeAirQuality">ç©ºæ°”è´¨é‡æŒ‡æ•°</label>
							<input type="number" id="lifeAirQuality" name="airQuality" value="50" min="0" max="500" class="form-input">
						</div>
						 
						<button type="submit" class="btn-primary" style="width: 100%;">ğŸš€ è·å–æ™ºèƒ½å»ºè®®</button>
					</form>
				</div>

				<div class="life-assistant-right">
					<h3>ğŸ’¡ æ™ºèƒ½å»ºè®®</h3>
					<div id="lifeAdviceContainer" class="advice-container">
						<div class="loading">è¯·è¾“å…¥å¤©æ°”ä¿¡æ¯å¹¶ç‚¹å‡»è·å–å»ºè®®</div>
					</div>
				</div>

				<div class="life-assistant-chat">
					<h3>ğŸ’¬ æ™ºèƒ½å¯¹è¯</h3>
					<div class="chat-messages">
						<div class="chat-message bot">
							ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„å¤©æ°”åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ
						</div>
					</div>
					<div class="chat-input-area">
						<input type="text" id="lifeChatInput" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." class="form-input chat-input">
						<button onclick="lifeSendMessage()" class="btn-primary">å‘é€</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="/static/app.js?v=ipcity1"></script>

	<script>
		// å¤©æ°”å»ºè®®åŠŸèƒ½è„šæœ¬
		document.addEventListener('DOMContentLoaded', function() {
			const getAdviceBtn = document.getElementById('get-advice-btn');
			const adviceResult = document.getElementById('weather-advice-result');
			const clothingAdvice = document.getElementById('clothing-advice');
			const travelAdvice = document.getElementById('travel-advice');
			const healthAdvice = document.getElementById('health-advice');
			const activityAdvice = document.getElementById('activity-advice');
			const alternativeBtns = document.querySelectorAll('.alternative-btn');

			getAdviceBtn.addEventListener('click', function() {
				const temperature = parseFloat(document.getElementById('temperature').value);
				const weather = document.getElementById('weather').value;
				const airQuality = parseInt(document.getElementById('air-quality').value);

				// å‘é€è¯·æ±‚åˆ°åç«¯è·å–å¤©æ°”å»ºè®®
				fetch('/api/weather_advice', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						temperature: temperature,
						weather: weather,
						air_quality: airQuality
					})
				})
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						clothingAdvice.textContent = data.advice['ç©¿è¡£æŒ‡æ•°'];
						travelAdvice.textContent = data.advice['å‡ºè¡Œå»ºè®®'];
						healthAdvice.textContent = data.advice['å¥åº·æé†’'];
						activityAdvice.textContent = data.advice['æ´»åŠ¨è§„åˆ’'];
						adviceResult.style.display = 'block';
					} else {
						alert('è·å–å»ºè®®å¤±è´¥: ' + data.error);
					}
				})
				.catch(error => {
					console.error('Error:', error);
					alert('è·å–å»ºè®®å¤±è´¥');
				});
			});

			// æ›¿ä»£å»ºè®®æŒ‰é’®äº‹ä»¶
			alternativeBtns.forEach(btn => {
				btn.addEventListener('click', function() {
					const category = this.getAttribute('data-category');
					const temperature = parseFloat(document.getElementById('temperature').value);
					const weather = document.getElementById('weather').value;
					const airQuality = parseInt(document.getElementById('air-quality').value);

					// è·å–å½“å‰å»ºè®®
					let currentAdvice;
					if (category === 'clothing') currentAdvice = clothingAdvice.textContent;
					else if (category === 'travel') currentAdvice = travelAdvice.textContent;
					else if (category === 'health') currentAdvice = healthAdvice.textContent;
					else if (category === 'activity') currentAdvice = activityAdvice.textContent;

					// å‘é€è¯·æ±‚è·å–æ›¿ä»£å»ºè®®
					fetch('/api/alternative_advice', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({
							category: category,
							weather_data: {
								temperature: temperature,
								weather: weather,
								air_quality: airQuality
							},
							previous_advice: currentAdvice
						})
					})
					.then(response => response.json())
					.then(data => {
						if (data.success) {
							if (category === 'clothing') clothingAdvice.textContent = data.alternative;
							else if (category === 'travel') travelAdvice.textContent = data.alternative;
							else if (category === 'health') healthAdvice.textContent = data.alternative;
							else if (category === 'activity') activityAdvice.textContent = data.alternative;
						} else {
							alert('è·å–æ›¿ä»£å»ºè®®å¤±è´¥: ' + data.error);
						}
					})
					.catch(error => {
						console.error('Error:', error);
						alert('è·å–æ›¿ä»£å»ºè®®å¤±è´¥');
					});
				});
			});
		});

		// æ·»åŠ lifeAssistantå®Œæ•´åŠŸèƒ½çš„JavaScript
		// å¤©æ°”å»ºè®®åŠŸèƒ½
		document.getElementById('lifeWeatherForm').addEventListener('submit', async function(e) {
			e.preventDefault();
			console.log('è¡¨å•æäº¤'); // æ·»åŠ è°ƒè¯•æ—¥å¿—
			
			const formData = {
				temperature: parseInt(document.getElementById('lifeTemperature').value),
				weather: document.getElementById('lifeWeather').value,
				air_quality: parseInt(document.getElementById('lifeAirQuality').value)
			};
			console.log('è¡¨å•æ•°æ®:', formData); // æ·»åŠ è°ƒè¯•æ—¥å¿—
			
			try {
				const response = await fetch('/api/weather_advice', { 
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(formData)
				});
				console.log('å“åº”çŠ¶æ€:', response.status); // æ·»åŠ è°ƒè¯•æ—¥å¿—
				
				const data = await response.json();
				console.log('å“åº”æ•°æ®:', data); // æ·»åŠ è°ƒè¯•æ—¥å¿—
				
				if (data.success) {
					// ç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®
					console.log('å»ºè®®æ•°æ®:', data.advice);
					lifeDisplayAdvice(data.advice);
				} else {
					alert('è·å–å»ºè®®å¤±è´¥ï¼š' + data.error);
				}
			} catch (error) {
				console.error('è¯·æ±‚é”™è¯¯:', error); // æ·»åŠ è°ƒè¯•æ—¥å¿—
				alert('è¯·æ±‚å¤±è´¥ï¼š' + error.message);
			}
		});

		function lifeDisplayAdvice(advice) {
			const container = document.getElementById('lifeAdviceContainer');
			container.innerHTML = '';
			
			// æ£€æŸ¥adviceæ˜¯å¦æ˜¯æœ‰æ•ˆçš„å¯¹è±¡
			if (!advice || typeof advice !== 'object') {
				console.error('æ— æ•ˆçš„å»ºè®®æ•°æ®:', advice);
				container.innerHTML = '<div class="error">æ— æ³•è·å–æœ‰æ•ˆå»ºè®®æ•°æ®</div>';
				return;
			}
			
			// é‡æ–°å®šä¹‰åˆ†ç±»æ ‡ç­¾ï¼Œè®©æ˜¾ç¤ºæ›´å‹å¥½
			const categoryLabels = {
				'clothing': 'ç©¿è¡£æŒ‡æ•°',
				'travel': 'å‡ºè¡Œå»ºè®®',
				'health': 'å¥åº·æé†’',
				'activity': 'æ´»åŠ¨è§„åˆ’',
				'ç©¿è¡£æŒ‡æ•°': 'ç©¿è¡£æŒ‡æ•°',
				'å‡ºè¡Œå»ºè®®': 'å‡ºè¡Œå»ºè®®',
				'å¥åº·æé†’': 'å¥åº·æé†’',
				'æ´»åŠ¨è§„åˆ’': 'æ´»åŠ¨è§„åˆ’'
			};
			
			// æ£€æŸ¥æ˜¯å¦æ˜¯ç©ºå¯¹è±¡
			if (Object.keys(advice).length === 0) {
				container.innerHTML = '<div class="no-advice">æš‚æ— å»ºè®®ï¼Œè¯·ç¨åå†è¯•</div>';
				return;
			}
			
			// éå†å¹¶æ˜¾ç¤ºå»ºè®®
			Object.entries(advice).forEach(([category, suggestion]) => {
				const card = document.createElement('div');
				card.className = 'advice-card';
				card.innerHTML = `
					<h4>${categoryLabels[category] || category}</h4>
					<p>${suggestion}</p>

					<button class="feedback-btn" onclick="lifeGetAlternativeAdvice('${category}', this)">
                        ä¸æ»¡æ„ï¼Ÿè·å–å…¶ä»–å»ºè®®
                    </button>
				`;
				container.appendChild(card);
			});
			
			// æ·»åŠ æ›¿ä»£å»ºè®®æŒ‰é’®äº‹ä»¶ç›‘å¬
			container.querySelectorAll('.alternative-btn').forEach(btn => {
				btn.addEventListener('click', function() {
					const category = this.getAttribute('data-category');
					lifeGetAlternativeAdvice(category, this);
				});
			});
		}

		async function lifeGetAlternativeAdvice(category, buttonElement) {
			try {
				// æ˜¾ç¤ºåŠ è½½çŠ¶æ€
				buttonElement.textContent = 'æ­£åœ¨è·å–...';
				buttonElement.disabled = true;
				
				// è·å–å½“å‰å¤©æ°”æ•°æ®
				const currentWeatherData = {
					temperature: parseInt(document.getElementById('lifeTemperature').value),
					weather: document.getElementById('lifeWeather').value,
					air_quality: parseInt(document.getElementById('lifeAirQuality').value)
				};
				
				// è·å–ä¹‹å‰çš„å»ºè®®å†…å®¹
				const card = buttonElement.closest('div');
				const suggestionElement = card.querySelector('p');
				const previousAdvice = suggestionElement.textContent;
				
				const response = await fetch('/api/alternative_advice', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({ 
						category: category,
						weather_data: currentWeatherData,
						previous_advice: previousAdvice
					})
				});
				
				const data = await response.json();
				
				if (data.success) {
					// æ›´æ–°å»ºè®®å†…å®¹
					suggestionElement.textContent = data.alternative;
					
					// æ›´æ–°æŒ‰é’®æ–‡æœ¬
					buttonElement.textContent = 'è¿˜ä¸æ»¡æ„ï¼Ÿå†æ¢ä¸€ä¸ª';
					buttonElement.disabled = false;
					
					// æ·»åŠ æˆåŠŸæç¤º
					lifeShowToast('å·²ä¸ºæ‚¨æä¾›æ–°çš„å»ºè®®ï¼', 'success');
				} else {
					alert('è·å–æ›¿ä»£å»ºè®®å¤±è´¥ï¼š' + data.error);
					buttonElement.textContent = 'ä¸æ»¡æ„ï¼Ÿè·å–å…¶ä»–å»ºè®®';
					buttonElement.disabled = false;
				}
			} catch (error) {
				alert('è¯·æ±‚å¤±è´¥ï¼š' + error.message);
				buttonElement.textContent = 'ä¸æ»¡æ„ï¼Ÿè·å–å…¶ä»–å»ºè®®';
				buttonElement.disabled = false;
			}
		}

		// èŠå¤©åŠŸèƒ½
		function lifeSendMessage() {
			const input = document.getElementById('lifeChatInput');
			const message = input.value.trim();
			
			if (message) {
				lifeAddMessage('user', message);
				input.value = '';
				
				// å‘é€åˆ°åç«¯
				fetch('/api/chat', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({ message: message })
				})
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						lifeAddMessage('bot', data.response);
					} else {
						lifeAddMessage('bot', 'æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€äº›é—®é¢˜ã€‚');
					}
				})
				.catch(error => {
					lifeAddMessage('bot', 'æŠ±æ­‰ï¼Œç½‘ç»œè¿æ¥å‡ºç°é—®é¢˜ã€‚');
				});
			}
		}

		function lifeAddMessage(sender, text) {
			// ä½¿ç”¨æ›´ç›´æ¥çš„é€‰æ‹©å™¨æ¥æŸ¥æ‰¾æ¶ˆæ¯å®¹å™¨
			const messagesContainer = document.querySelector('.life-assistant-chat .chat-messages');
			const message = document.createElement('div');
			message.className = `chat-message ${sender}`;
			message.textContent = text;
			messagesContainer.appendChild(message);
			messagesContainer.scrollTop = messagesContainer.scrollHeight;
		}

		// å›è½¦å‘é€æ¶ˆæ¯
		document.getElementById('lifeChatInput').addEventListener('keypress', function(e) {
			if (e.key === 'Enter') {
				lifeSendMessage();
			}
		});

		// æ·»åŠ æç¤ºæ¶ˆæ¯åŠŸèƒ½
		function lifeShowToast(message, type = 'info') {
			const toast = document.createElement('div');
			toast.className = `toast toast-${type}`;
			toast.textContent = message;
			// ä¿®å¤CSSå˜é‡ä½¿ç”¨æ–¹å¼
			toast.style.position = 'fixed';
			toast.style.top = '20px';
			toast.style.right = '20px';
			toast.style.backgroundColor = type === 'success' ? 'var(--primary)' : 'var(--primary-600)';
			toast.style.color = 'white';
			toast.style.padding = '12px 20px';
			toast.style.borderRadius = '5px';
			toast.style.zIndex = '1000';
			toast.style.animation = 'slideIn 0.3s ease';
			
			document.body.appendChild(toast);
			
			setTimeout(() => {
				toast.style.animation = 'slideOut 0.3s ease';
				setTimeout(() => {
					document.body.removeChild(toast);
				}, 300);
			}, 2000);
		}

		// æ·»åŠ CSSåŠ¨ç”»
		const style = document.createElement('style');
		style.textContent = `
			@keyframes slideIn {
				from { transform: translateX(100%); opacity: 0; }
				to { transform: translateX(0); opacity: 1; }
			}
			@keyframes slideOut {
				from { transform: translateX(0); opacity: 1; }
				to { transform: translateX(100%); opacity: 0; }
			}
			.chat-message {
				margin-bottom: 15px; 
				padding: 10px 15px; 
				border-radius: 10px; 
				max-width: 80%;
			}
			.chat-message.user {
				background-color: var(--primary);
				color: white;
				margin-left: auto;
			}
			.chat-message.bot {
				background-color: var(--chip-bg);
				color: var(--fg);
			}
			
			/* ä¼˜åŒ–æ·±è‰²æ¨¡å¼ä¸‹çš„é¢œè‰²æ˜¾ç¤º */
			[data-theme="dark"] .chat-message.bot {
				background-color: var(--card-bg);
				border: 1px solid var(--card-border);
			}
			
			[data-theme="dark"] .advice-card {
				background-color: var(--card-bg);
				border: 1px solid var(--card-border);
				padding: 15px;
				border-radius: 10px;
				margin-bottom: 15px;
			}
			
			[data-theme="dark"] .toast {
				background-color: rgba(59, 130, 246, 0.9) !important;
			}
			
			/* ç¡®ä¿lifeAssistantæ¨¡å—ä¸åŸé¡µé¢ä¿æŒä¸€è‡´å®½åº¦ */
			.life-assistant-full {
				max-width: 1080px;
				margin: 0 auto;
				padding: 0 18px;
			}
		`;
		document.head.appendChild(style);
	</script>
</body>
</html>
